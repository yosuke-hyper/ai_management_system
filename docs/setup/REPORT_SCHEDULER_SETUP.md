# ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2025å¹´11æœˆ10æ—¥
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0

---

## ğŸ“Š æ¦‚è¦

ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãŒ**å®Œå…¨ã«å®Ÿè£…**ã•ã‚Œã¦ã„ã¾ã™ã€‚

### å®Ÿè£…æ¸ˆã¿ã®æ©Ÿèƒ½

âœ… **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†UI**
- é€±æ¬¡ãƒ»æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‰Šé™¤
- å®Ÿè¡Œå±¥æ­´ã®è¡¨ç¤º

âœ… **Edge Function**
- `scheduled-report-generator` - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å¾“ã£ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ

âœ… **Supabase Cron Job**
- æ¯æ™‚0åˆ†ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
- å®Ÿè¡Œã™ã¹ããƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ

âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**
- `report_schedules` - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
- `report_generation_logs` - å®Ÿè¡Œãƒ­ã‚°
- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨ãƒˆãƒªã‚¬ãƒ¼

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Cron Job (æ¯æ™‚0åˆ†å®Ÿè¡Œ)                             â”‚
â”‚ SELECT cron.schedule('generate-scheduled-reports', ...)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function: scheduled-report-generator                  â”‚
â”‚ - report_schedulesã‹ã‚‰å®Ÿè¡Œã™ã¹ãã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—          â”‚
â”‚ - å„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function: generate-ai-report                          â”‚
â”‚ - æŒ‡å®šæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ                                     â”‚
â”‚ - OpenAI GPT-4ã§AIåˆ†æ                                      â”‚
â”‚ - ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€šçŸ¥ãƒ»ãƒ¡ãƒ¼ãƒ«é€ä¿¡                                             â”‚
â”‚ - notification_emailsã«è¨­å®šã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€šçŸ¥       â”‚
â”‚ - send-report-email Edge Functionã§é€ä¿¡                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã€Cron Jobã¨å¿…è¦ãªé–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
# Supabase CLIã‚’ä½¿ç”¨
supabase db push

# ã¾ãŸã¯ç‰¹å®šã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿
supabase migration up
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«:
- `20251110120000_setup_report_scheduler_cron.sql`

### ã‚¹ãƒ†ãƒƒãƒ—2: Edge Functionã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
supabase functions deploy scheduled-report-generator

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–¢æ•°ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæœªãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆï¼‰
supabase functions deploy generate-ai-report
```

### ã‚¹ãƒ†ãƒƒãƒ—3: Supabaseè¨­å®šã®ç¢ºèª

Supabase Dashboardã§ä»¥ä¸‹ã‚’ç¢ºèª:

1. **pg_cronæ‹¡å¼µæ©Ÿèƒ½**
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ Database â†’ Extensions
   - `pg_cron`ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

2. **Cron Jobã®ç¢ºèª**
   ```sql
   SELECT * FROM cron.job WHERE jobname = 'generate-scheduled-reports';
   ```

   æœŸå¾…ã•ã‚Œã‚‹çµæœ:
   ```
   jobid | schedule  | command                      | nodename | nodeport | database | username | active | jobname
   ------+-----------+------------------------------+----------+----------+----------+----------+--------+-------------------------
   1     | 0 * * * * | SELECT net.http_post(...)    | ...      | ...      | ...      | ...      | true   | generate-scheduled-reports
   ```

### ã‚¹ãƒ†ãƒƒãƒ—4: ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

Cron JobãŒç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€Supabase Secretsã«è¨­å®š:

```bash
# å¿…è¦ã«å¿œã˜ã¦
supabase secrets set OPENAI_API_KEY=sk-xxxxxxxxxxxxx
supabase secrets set RESEND_API_KEY=re-xxxxxxxxxxxxx
```

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### 1. ç®¡ç†ç”»é¢ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆ

1. ç®¡ç†ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³
2. ã€Œç®¡ç†è¨­å®šã€â†’ã€Œãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚’é¸æŠ
3. ã€Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

**è¨­å®šé …ç›®**:
- **ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥**: é€±æ¬¡ or æœˆæ¬¡
- **å¯¾è±¡åº—èˆ—**: å…¨åº—èˆ— or ç‰¹å®šåº—èˆ—
- **é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°æŒ‡å®šå¯èƒ½

### 2. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¾‹

#### é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
```
ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥: é€±æ¬¡
å¯¾è±¡åº—èˆ—: å…¨åº—èˆ—
Cronå¼: 0 6 * * 1  (æ¯é€±æœˆæ›œ 6:00)
é€šçŸ¥å…ˆ: manager@example.com, owner@example.com
```

#### æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼ˆç‰¹å®šåº—èˆ—ï¼‰
```
ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥: æœˆæ¬¡
å¯¾è±¡åº—èˆ—: æ–°å®¿åº—
Cronå¼: 0 6 1 * *  (æ¯æœˆ1æ—¥ 6:00)
é€šçŸ¥å…ˆ: shinjuku@example.com
```

### 3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–

- ä¸€æ™‚çš„ã«åœæ­¢ã—ãŸã„å ´åˆã¯ã€Œç„¡åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
- å†é–‹ã™ã‚‹å ´åˆã¯ã€Œæœ‰åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

### 4. å®Ÿè¡Œå±¥æ­´ã®ç¢ºèª

- å„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã«ã€Œå‰å›å®Ÿè¡Œã€ã¨ã€Œæ¬¡å›å®Ÿè¡Œã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
- è©³ç´°ãªãƒ­ã‚°ã¯ `report_generation_logs` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§

---

## ğŸ”§ Cronå¼ã®è¨­å®š

### åŸºæœ¬ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```
åˆ† æ™‚ æ—¥ æœˆ æ›œæ—¥
â”‚ â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€ æ›œæ—¥ (0-7, 0=æ—¥æ›œ, 7=æ—¥æ›œ)
â”‚ â”‚ â”‚ â””â”€â”€â”€ æœˆ (1-12)
â”‚ â”‚ â””â”€â”€â”€â”€â”€ æ—¥ (1-31)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€ æ™‚ (0-23)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ† (0-59)
```

### ã‚ˆãä½¿ã†ãƒ‘ã‚¿ãƒ¼ãƒ³

| èª¬æ˜ | Cronå¼ | å‚™è€ƒ |
|------|--------|------|
| **æ¯é€±æœˆæ›œ 6:00** | `0 6 * * 1` | é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®æ¨å¥¨ |
| **æ¯æœˆ1æ—¥ 6:00** | `0 6 1 * *` | æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®æ¨å¥¨ |
| **æ¯æ—¥ 6:00** | `0 6 * * *` | æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ |
| **æ¯é€±é‡‘æ›œ 18:00** | `0 18 * * 5` | é€±æœ«å‰ã®ãƒ¬ãƒãƒ¼ãƒˆ |
| **æ¯æœˆæœ€çµ‚æ—¥ 23:00** | `0 23 L * *` | æœˆæœ«ãƒ¬ãƒãƒ¼ãƒˆï¼ˆâ€»Lã¯æœªã‚µãƒãƒ¼ãƒˆï¼‰ |

### ã‚«ã‚¹ã‚¿ãƒ Cronå¼

UIã‹ã‚‰ä½œæˆã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯è‡ªå‹•çš„ã«é©åˆ‡ãªCronå¼ãŒè¨­å®šã•ã‚Œã¾ã™ãŒã€
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ç›´æ¥ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚‚å¯èƒ½ã§ã™:

```sql
UPDATE report_schedules
SET cron_expression = '0 18 * * 5',  -- æ¯é€±é‡‘æ›œ 18:00
    next_run_at = calculate_next_run_time('0 18 * * 5')
WHERE id = 'schedule-uuid';
```

---

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œãªã„

**1. Cron JobãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª**
```sql
SELECT jobname, last_run, last_run_status, run_details
FROM cron.job_run_details
WHERE jobname = 'generate-scheduled-reports'
ORDER BY start_time DESC
LIMIT 10;
```

**2. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæœ‰åŠ¹ã‹ç¢ºèª**
```sql
SELECT id, report_type, is_enabled, next_run_at
FROM report_schedules
WHERE is_enabled = true;
```

**3. Edge Functionã®ãƒ­ã‚°ã‚’ç¢ºèª**
```bash
supabase functions logs scheduled-report-generator --tail
```

### next_run_atãŒæ›´æ–°ã•ã‚Œãªã„

**åŸå› **: Edge Functionã§ã®æ›´æ–°å‡¦ç†ãŒå¤±æ•—

**å¯¾å‡¦æ³•**:
```sql
-- æ‰‹å‹•ã§æ¬¡å›å®Ÿè¡Œæ™‚åˆ»ã‚’å†è¨ˆç®—
UPDATE report_schedules
SET next_run_at = calculate_next_run_time(cron_expression)
WHERE id = 'schedule-uuid';
```

### ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„

**åŸå› **: `notification_emails`ãŒæœªè¨­å®šã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼

**å¯¾å‡¦æ³•**:
1. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèª
2. `send-report-email` Edge Functionã®ãƒ­ã‚°ã‚’ç¢ºèª
3. Resend APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### report_schedules ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
|---------|---|------|
| id | uuid | ä¸»ã‚­ãƒ¼ |
| organization_id | uuid | çµ„ç¹”IDï¼ˆRLSï¼‰ |
| report_type | text | 'weekly' or 'monthly' |
| store_id | uuid | å¯¾è±¡åº—èˆ—ï¼ˆNULLã¯å…¨åº—èˆ—ï¼‰ |
| is_enabled | boolean | æœ‰åŠ¹/ç„¡åŠ¹ |
| cron_expression | text | Cronå¼ |
| last_run_at | timestamptz | å‰å›å®Ÿè¡Œæ—¥æ™‚ |
| next_run_at | timestamptz | æ¬¡å›å®Ÿè¡Œäºˆå®šæ—¥æ™‚ |
| notification_emails | text[] | é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é…åˆ— |
| created_at | timestamptz | ä½œæˆæ—¥æ™‚ |
| updated_at | timestamptz | æ›´æ–°æ—¥æ™‚ |

### report_generation_logs ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
|---------|---|------|
| id | uuid | ä¸»ã‚­ãƒ¼ |
| organization_id | uuid | çµ„ç¹”IDï¼ˆRLSï¼‰ |
| schedule_id | uuid | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«IDï¼ˆNULLå¯ï¼‰ |
| report_id | uuid | ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆID |
| report_type | text | ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥ |
| store_id | uuid | å¯¾è±¡åº—èˆ— |
| status | text | 'success', 'failed', 'in_progress' |
| started_at | timestamptz | é–‹å§‹æ—¥æ™‚ |
| completed_at | timestamptz | å®Œäº†æ—¥æ™‚ |
| error_message | text | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| data_summary | jsonb | å®Ÿè¡Œã‚µãƒãƒªãƒ¼ |
| created_at | timestamptz | ä½œæˆæ—¥æ™‚ |

---

## ğŸ¯ é«˜åº¦ãªæ©Ÿèƒ½

### 1. è¤‡æ•°åº—èˆ—å‘ã‘ã®ãƒãƒƒãƒå‡¦ç†

å…¨åº—èˆ—åˆ†ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¸€åº¦ã«ç”Ÿæˆ:

```sql
INSERT INTO report_schedules (
  organization_id,
  report_type,
  store_id,
  cron_expression,
  is_enabled
)
SELECT
  'org-uuid',
  'weekly',
  id,
  '0 6 * * 1',
  true
FROM stores
WHERE organization_id = 'org-uuid';
```

### 2. ã‚«ã‚¹ã‚¿ãƒ å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯

ç‰¹å®šã®æ¡ä»¶ã§ã®ã¿ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ:

```sql
-- å£²ä¸ŠãŒä¸€å®šé¡ä»¥ä¸Šã®åº—èˆ—ã®ã¿ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
CREATE OR REPLACE FUNCTION should_generate_report(p_store_id uuid)
RETURNS boolean AS $$
DECLARE
  v_sales numeric;
BEGIN
  SELECT SUM(sales)
  INTO v_sales
  FROM daily_reports
  WHERE store_id = p_store_id
    AND date >= current_date - interval '7 days';

  RETURN v_sales > 1000000;  -- 100ä¸‡å††ä»¥ä¸Š
END;
$$ LANGUAGE plpgsql;
```

### 3. å¤±æ•—æ™‚ã®ãƒªãƒˆãƒ©ã‚¤

Edge Functionã«å®Ÿè£…:

```typescript
// scheduled-report-generator/index.ts
const MAX_RETRIES = 3;
let retryCount = 0;

while (retryCount < MAX_RETRIES) {
  try {
    await generateReport(...);
    break;
  } catch (error) {
    retryCount++;
    if (retryCount >= MAX_RETRIES) {
      // ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¦æ¬¡ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸
      await logFailure(schedule.id, error);
    }
    await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
  }
}
```

---

## ğŸ“ˆ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### å®Ÿè¡Œçµ±è¨ˆã®ç¢ºèª

```sql
-- éå»30æ—¥é–“ã®å®Ÿè¡Œçµ±è¨ˆ
SELECT
  DATE(started_at) as execution_date,
  status,
  COUNT(*) as count
FROM report_generation_logs
WHERE started_at >= current_date - interval '30 days'
GROUP BY DATE(started_at), status
ORDER BY execution_date DESC;
```

### å¤±æ•—ã—ãŸãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª

```sql
-- å¤±æ•—ã—ãŸãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
SELECT
  rgl.id,
  rgl.started_at,
  rgl.error_message,
  rs.report_type,
  s.name as store_name
FROM report_generation_logs rgl
LEFT JOIN report_schedules rs ON rs.id = rgl.schedule_id
LEFT JOIN stores s ON s.id = rgl.store_id
WHERE rgl.status = 'failed'
ORDER BY rgl.started_at DESC
LIMIT 20;
```

### å¤ã„ãƒ­ã‚°ã®å‰Šé™¤

```sql
-- 90æ—¥ä»¥ä¸Šå‰ã®ãƒ­ã‚°ã‚’å‰Šé™¤
DELETE FROM report_generation_logs
WHERE started_at < current_date - interval '90 days';
```

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. RLSï¼ˆRow Level Securityï¼‰

ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSãŒæœ‰åŠ¹:
```sql
-- report_schedulesã¯çµ„ç¹”ã”ã¨ã«åˆ†é›¢
CREATE POLICY "Users can view own org schedules"
ON report_schedules
FOR SELECT
TO authenticated
USING (organization_id IN (
  SELECT organization_id FROM organization_members
  WHERE user_id = auth.uid()
));
```

### 2. å®Ÿè¡Œæ¨©é™

Cron Jobã¯`SERVICE_ROLE_KEY`ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€
ã™ã¹ã¦ã®çµ„ç¹”ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚

Edge Functionå†…ã§RLSãƒãƒªã‚·ãƒ¼ãŒé©åˆ‡ã«é©ç”¨ã•ã‚Œã‚‹ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

### 3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™

OpenAI APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«æ³¨æ„:
- çµ„ç¹”ã‚ãŸã‚Šã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶é™
- å¤±æ•—æ™‚ã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤

---

## ğŸ’¡ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‘½å

ã‚ã‹ã‚Šã‚„ã™ã„å‘½åè¦å‰‡ã‚’ä½¿ç”¨:
```
é€±æ¬¡_å…¨åº—èˆ—_æœˆæ›œæœ
æœˆæ¬¡_æ–°å®¿åº—_æœˆåˆ
```

### 2. é€šçŸ¥å…ˆã®ç®¡ç†

- è¤‡æ•°ã®ç®¡ç†è€…ã‚’è¨­å®š
- é‡è¦ãªãƒ¬ãƒãƒ¼ãƒˆã¯è¤‡æ•°ã®é€šçŸ¥å…ˆ
- åº—èˆ—åˆ¥ãƒ¬ãƒãƒ¼ãƒˆã¯åº—é•·ã®ã¿

### 3. å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

- è² è·ã®å°‘ãªã„æ—©æœã«å®Ÿè¡Œ
- åŒæ™‚å®Ÿè¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã€æ™‚é–“ã‚’ãšã‚‰ã™
- ãƒ‡ãƒ¼ã‚¿ãŒç¢ºå®šã—ãŸå¾Œã«å®Ÿè¡Œï¼ˆä¾‹: å‰æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ï¼‰

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- å¤±æ•—ã—ã¦ã‚‚æ¬¡å›ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å½±éŸ¿ã—ãªã„
- ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’ç®¡ç†è€…ã«é€ä¿¡
- è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã®å®Ÿè£…

---

## ğŸ‰ å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] pg_cronæ‹¡å¼µæ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–ç¢ºèª
- [ ] Cron Jobã®ç™»éŒ²ç¢ºèª
- [ ] Edge Functionsã®ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ†ã‚¹ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

### ãƒ†ã‚¹ãƒˆ

- [ ] æ‰‹å‹•ã§ã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ
- [ ] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆã®ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã®ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã®ãƒ†ã‚¹ãƒˆ
- [ ] å®Ÿè¡Œãƒ­ã‚°ã®ç¢ºèª

### æœ¬ç•ªé‹ç”¨

- [ ] å®šæœŸçš„ãªãƒ­ã‚°ç¢ºèªã®è¨­å®š
- [ ] å¤±æ•—æ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
- [ ] å¤ã„ãƒ­ã‚°ã®è‡ªå‹•å‰Šé™¤è¨­å®š
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ç¢ºèª

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Supabase pg_cron](https://supabase.com/docs/guides/database/extensions/pg_cron)
- [Cronå¼ã®èª¬æ˜](https://crontab.guru/)
- [Edge Functions](https://supabase.com/docs/guides/functions)

---

**ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãŒå®Œå…¨ã«æ©Ÿèƒ½ã—ã¾ã™ï¼** ğŸŠ

å®šæœŸçš„ãªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«ã‚ˆã‚Šã€çµŒå–¶åˆ¤æ–­ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚
