# システムヘルスモニタリング機能

## 概要

初期運用（1-10組織）を想定した基本的なヘルスダッシュボードを実装しました。スーパー管理者が、システム全体の健全性、パフォーマンス、リソース使用状況をリアルタイムで監視できます。

## 主な機能

### 1. リアルタイムシステムステータス

- **システム全体のステータス**: 正常、警告、障害の3段階で表示
- **自動更新**: 30秒ごとに自動リフレッシュ
- **手動更新**: 更新ボタンでいつでも最新情報を取得

### 2. 主要メトリクス（4つのカード）

- **データベース接続状態**: 接続の正常性を監視
- **アクティブユーザー数**: 過去24時間のアクティブユーザー
- **エラー数**: 過去24時間のエラー件数（重大エラーも表示）
- **平均応答時間**: APIの平均応答時間（ミリ秒）

### 3. パフォーマンス監視

- **応答時間の推移グラフ**: 過去24時間のAPI応答時間を視覚化
- **リクエスト統計**: 総リクエスト数、エラー率を表示
- **リアルタイムチャート**: Chart.jsを使用した滑らかなグラフ

### 4. リソース使用状況

- **組織・店舗・ユーザー統計**: システム全体のリソース概要
- **AI使用量**: 本日のAIリクエスト数と使用率（プログレスバー）
- **データベース概要**: 接続状態、総レコード数、アクティビティ率
- **使用率警告**: AI使用率が80%を超えると警告を表示

### 5. アラートシステム

- **重大度別表示**: Critical（重大）、High（高）、Medium（中）、Low（低）
- **カテゴリ分類**: エラー、パフォーマンス、リソース、セキュリティ
- **タイムスタンプ**: 各アラートの発生時刻を表示
- **リアルタイム更新**: 最新のエラーログから自動取得

## 技術構成

### データベース

#### テーブル

1. **system_health_metrics** - システムヘルスメトリクスの記録
   - 組織数、店舗数、ユーザー数
   - エラー統計（1時間、24時間、重大エラー）
   - パフォーマンス情報
   - AI使用量
   - 全体ステータス（healthy/warning/critical）

2. **api_performance_logs** - APIパフォーマンスログ
   - エンドポイント、メソッド
   - 応答時間（ミリ秒）
   - ステータスコード
   - エラーメッセージ

#### 関数

1. **get_system_health_stats()** - 現在のシステム統計を取得
2. **get_performance_summary(hours)** - パフォーマンスサマリーを取得
3. **cleanup_old_metrics()** - 30日以上古いメトリクスを削除

#### セキュリティ

- RLS (Row Level Security) が有効
- スーパー管理者のみアクセス可能
- 全てのテーブルでポリシーを設定

### Edge Function

**health-check** - システムヘルス情報を取得
- エンドポイント: `/functions/v1/health-check`
- 認証: JWT必須（スーパー管理者のみ）
- レスポンス: HealthMetrics型のJSON

### フロントエンド

#### コンポーネント階層

```
SystemHealthDashboard (メインコンポーネント)
├── SystemStatusBadge (ステータスバッジ)
├── HealthMetricCard x4 (メトリクスカード)
└── Tabs
    ├── 概要タブ
    │   ├── PerformanceMetrics (パフォーマンス)
    │   └── ResourceUsageOverview (リソース)
    ├── パフォーマンスタブ
    ├── リソースタブ
    └── アラートタブ
        └── SystemAlertsPanel (アラート一覧)
```

#### カスタムフック

1. **useSystemHealth** - システムヘルス情報の管理
   - 自動リフレッシュ機能
   - エラーハンドリング
   - 最終更新時刻の追跡

2. **usePerformanceMetrics** - パフォーマンスデータの管理
   - 時系列データの取得
   - トレンド分析

#### サービスレイヤー

**systemHealthService** - ヘルスデータのCRUD操作
- getHealthMetrics() - 最新のヘルス情報を取得
- getRecentHealthHistory() - 履歴データを取得
- getPerformanceTrends() - パフォーマンストレンドを取得
- getRecentAlerts() - 最新のアラートを取得
- recordPerformanceLog() - パフォーマンスログを記録

## アクセス方法

1. スーパー管理者としてログイン
2. 「設定（管理）」ページに移動
3. 「システム監視」タブをクリック

### デモモード・非スーパー管理者の場合

- デモモードまたは非スーパー管理者でアクセスした場合、サンプルデータが表示されます
- 画面上部に青色のバナーが表示され、参考データであることを示します
- 実際のシステムヘルス情報を確認するには、スーパー管理者権限が必要です

## 主要な指標

### ステータスの判定基準

- **正常 (Healthy)**
  - 重大エラー: 5件以下/24時間
  - エラー率: 5%以下
  - データベース接続: 正常

- **警告 (Warning)**
  - 重大エラー: 6-10件/24時間
  - エラー率: 5-10%

- **障害 (Critical)**
  - 重大エラー: 10件超/24時間
  - エラー率: 10%超
  - データベース接続: 切断

### パフォーマンス指標

- **応答時間**
  - 正常: 500ms以下
  - 警告: 500-1000ms
  - 問題: 1000ms超

- **エラー率**
  - 正常: 5%以下
  - 警告: 5-10%
  - 問題: 10%超

## データ保持期間

- システムヘルスメトリクス: 30日間
- APIパフォーマンスログ: 30日間
- 古いデータは自動的にクリーンアップされます

## 今後の拡張予定

### フェーズ2（10-50組織）
- アラート通知機能（メール/Slack）
- より詳細なパフォーマンス分析
- カスタムダッシュボード
- メトリクスのエクスポート機能

### フェーズ3（50組織以上）
- 予測分析とトレンド予測
- 異常検知アラート
- 自動スケーリング提案
- SLA監視とレポート

## トラブルシューティング

### データが表示されない場合

1. スーパー管理者権限を確認
   - `system_admins` テーブルにユーザーが登録されているか確認
   - デモモードの場合は自動的にサンプルデータが表示されます
2. Edge Functionのデプロイ状態を確認
3. データベース接続を確認
4. ブラウザのコンソールでエラーを確認

### 403 Forbidden エラーが表示される場合

- スーパー管理者権限が不足しています
- 自動的にサンプルデータに切り替わります
- 実データを見るには、`system_admins` テーブルにユーザーを追加してください

### パフォーマンスが遅い場合

1. データベースインデックスを確認
2. 古いメトリクスをクリーンアップ
3. リフレッシュ間隔を調整（30秒→60秒）

### アラートが多すぎる場合

1. エラーログの重大度設定を確認
2. 閾値を調整（ステータス判定基準）
3. フィルタリング機能を追加検討

## セキュリティ考慮事項

- スーパー管理者のみアクセス可能
- RLSによるデータベースレベルの保護
- JWTトークンによる認証
- 機密情報の暗号化（将来対応）

## パフォーマンス最適化

- インデックス最適化済み
- 30秒ごとの自動更新（調整可能）
- ページネーションとフィルタリング
- 必要最小限のデータ取得

## まとめ

このシステムヘルスモニタリング機能により、スーパー管理者は：

1. システム全体の健全性をリアルタイムで把握
2. パフォーマンス問題を早期発見
3. リソース使用状況を監視
4. エラーとアラートに迅速に対応

初期運用フェーズに必要な基本的な監視機能を提供し、システムの安定稼働をサポートします。
